<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap');
        body { font-family: 'Sarabun', sans-serif; background-color: #f3f4f6; }
        .loading { display: none; }
    </style>
</head>
<body class="p-4">

    <div class="max-w-md mx-auto bg-white rounded-xl shadow-md overflow-hidden md:max-w-2xl p-6">
        <div class="text-center mb-6">
            <h2 class="text-2xl font-bold text-gray-800">üì¢ ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢</h2>
            <p class="text-sm text-gray-500">‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏Å‡∏≤‡∏ç‡∏à‡∏ô‡∏≤‡∏†‡∏¥‡πÄ‡∏©‡∏Å</p>
        </div>

        <form id="repairForm" class="space-y-4">
            
            <div>
                <label class="block text-sm font-medium text-gray-700">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏õ‡∏±‡∏ç‡∏´‡∏≤ <span class="text-red-500">*</span></label>
                <select id="category" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border bg-gray-50">
                    <option value="" disabled selected>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà --</option>
                    <option value="‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡∏£‡∏≤">üçÑ ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡∏£‡∏≤</option>
                    <option value="‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ">‚ò£Ô∏è ‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ‡∏£‡∏±‡πà‡∏ß‡πÑ‡∏´‡∏•/‡∏Å‡∏•‡∏¥‡πà‡∏ô</option>
                    <option value="‡πÑ‡∏ü‡∏ü‡πâ‡∏≤/‡πÅ‡∏™‡∏á‡∏™‡∏ß‡πà‡∏≤‡∏á">‚ö° ‡πÑ‡∏ü‡∏ü‡πâ‡∏≤/‡πÅ‡∏™‡∏á‡∏™‡∏ß‡πà‡∏≤‡∏á</option>
                    <option value="‡∏Å‡∏≤‡∏¢‡∏†‡∏≤‡∏û/‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á">üèóÔ∏è ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á/‡∏û‡∏∑‡πâ‡∏ô/‡πÄ‡∏û‡∏î‡∏≤‡∏ô</option>
                    <option value="‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ">üì¢ ‡∏≠‡∏∑‡πà‡∏ô‡πÜ / ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</option>
                </select>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£/‡∏ï‡∏∂‡∏Å <span class="text-red-500">*</span></label>
                    <select id="building" class="mt-1 block w-full rounded-md border p-2 bg-gray-50">
                        <option value="‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£">‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£</option>
                        <option value="‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ô‡∏≠‡∏Å">‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ô‡∏≠‡∏Å</option>
                        <option value="‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏™‡∏ô‡∏±‡∏ö‡∏™‡∏ô‡∏∏‡∏ô">‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏™‡∏ô‡∏±‡∏ö‡∏™‡∏ô‡∏∏‡∏ô</option>
                        <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">‡∏ä‡∏±‡πâ‡∏ô <span class="text-red-500">*</span></label>
                    <input type="text" id="floor" placeholder="‡πÄ‡∏ä‡πà‡∏ô 3" class="mt-1 block w-full rounded-md border p-2 bg-gray-50">
                </div>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700">‡∏´‡πâ‡∏≠‡∏á / ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏û‡∏ö <span class="text-red-500">*</span></label>
                <input type="text" id="room" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô, ‡∏´‡πâ‡∏≠‡∏á‡∏ô‡πâ‡∏≥‡∏ä‡∏≤‡∏¢" class="mt-1 block w-full rounded-md border p-2 bg-gray-50">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£ <span class="text-red-500">*</span></label>
                <textarea id="detail" rows="3" placeholder="‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢..." class="mt-1 block w-full rounded-md border p-2 bg-gray-50"></textarea>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700">‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏ñ‡πà‡∏≤‡∏¢ (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 3 ‡∏£‡∏π‡∏õ)</label>
                <input type="file" id="images" multiple accept="image/*" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                <p class="text-xs text-gray-400 mt-1">*‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡∏•‡∏∞‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏π‡∏õ</p>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á</label>
                    <input type="text" id="reporter" readonly class="mt-1 block w-full rounded-md border p-2 bg-gray-100 text-gray-500 cursor-not-allowed">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ <span class="text-red-500">*</span></label>
                    <input type="tel" id="tel" placeholder="0xxxxxxxxx" class="mt-1 block w-full rounded-md border p-2 bg-gray-50">
                </div>
            </div>

            <button type="button" onclick="submitForm()" id="submitBtn" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                üöÄ ‡∏™‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏
            </button>
        </form>
    </div>

    <div id="loadingOverlay" class="loading fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white p-5 rounded-lg flex flex-col items-center">
            <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-indigo-600 mb-3"></div>
            <p class="text-gray-700">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
        </div>
    </div>

    <script>
        // ================= CONFIG =================
        // üëáüëá ‡πÄ‡∏≠‡∏≤ URL ‡∏Ç‡∏≠‡∏á Apps Script (‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢ /exec) ‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ !!! üëáüëá
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyWNYN_WZVBOnmsegtajxRke5uiHbC1lCHU1D2nQSbiDYJp-seE56dHo8VEgpGXS-96ug/exec"; 
        // ==========================================

        let userProfile = {};

        // 1. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à
        async function main() {
            // ‡πÉ‡∏™‡πà LIFF ID ‡∏Ç‡∏≠‡∏á "User Report" (‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤ Line Dev)
            // ‡πÅ‡∏ï‡πà‡∏õ‡∏Å‡∏ï‡∏¥ LIFF ‡∏à‡∏∞‡∏£‡∏π‡πâ‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏ú‡πà‡∏≤‡∏ô‡∏•‡∏¥‡∏á‡∏Å‡πå liff.line.me
            await liff.init({ liffId: liff.getContext()?.liffId || "" }); 
            
            if (liff.isLoggedIn()) {
                const profile = await liff.getProfile();
                userProfile = profile;
                document.getElementById('reporter').value = profile.displayName;
            } else {
                liff.login();
            }
        }
        main();

        // 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        async function submitForm() {
            // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏°
            const category = document.getElementById('category').value;
            const building = document.getElementById('building').value;
            const floor = document.getElementById('floor').value;
            const room = document.getElementById('room').value;
            const detail = document.getElementById('detail').value;
            const tel = document.getElementById('tel').value;
            const imageInput = document.getElementById('images');

            // Validation ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á
            if (!category || !floor || !room || !detail || !tel) {
                Swal.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏î‡∏≠‡∏Å‡∏à‡∏±‡∏ô * ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', 'warning');
                return;
            }

            // ‡πÅ‡∏™‡∏î‡∏á Loading
            document.getElementById('loadingOverlay').style.display = 'flex';
            document.getElementById('submitBtn').disabled = true;

            try {
                // ‡πÅ‡∏õ‡∏•‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏õ‡πá‡∏ô Base64
                let imageBase64s = [];
                if (imageInput.files.length > 0) {
                    for (let file of imageInput.files) {
                        let base64 = await toBase64(file);
                        imageBase64s.push(base64);
                    }
                }

                // ‡πÅ‡∏û‡πá‡∏Ñ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏™‡πà‡∏á
                const payload = {
                    action: 'submit_job', // ‡∏ö‡∏≠‡∏Å Server ‡∏ß‡πà‡∏≤‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô
                    userId: userProfile.userId || "GUEST",
                    reporter: userProfile.displayName || document.getElementById('reporter').value,
                    category, building, floor, room, detail, tel,
                    images: imageBase64s // ‡∏™‡πà‡∏á‡∏£‡∏π‡∏õ‡πÑ‡∏õ‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡πâ‡∏≠‡∏ô
                };

                // ‡∏¢‡∏¥‡∏á‡πÑ‡∏õ‡∏´‡∏≤ Google Apps Script
                // *‡πÉ‡∏ä‡πâ mode: 'no-cors' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ Cross-Origin ‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô
                await fetch(WEB_APP_URL, {
                    method: 'POST',
                    mode: 'no-cors', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                // *‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å no-cors ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏à‡∏£‡∏¥‡∏á‡πÑ‡∏´‡∏° ‡πÅ‡∏ï‡πà‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏ï‡∏¥‡πä‡∏ï‡πà‡∏≤‡∏á‡∏ß‡πà‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à*
                // (‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏£‡∏≠‡∏î‡∏π Push Message ‡πÉ‡∏ô‡πÑ‡∏•‡∏ô‡πå‡πÄ‡∏≠‡∏≤)
                document.getElementById('loadingOverlay').style.display = 'none';
                
                await Swal.fire({
                    icon: 'success',
                    title: '‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                    text: '‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Å‡∏•‡∏±‡∏ö',
                    confirmButtonText: '‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á'
                });
                
                liff.closeWindow(); // ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤ LIFF

            } catch (error) {
                console.error(error);
                document.getElementById('loadingOverlay').style.display = 'none';
                document.getElementById('submitBtn').disabled = false;
                Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà', 'error');
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏õ‡πá‡∏ô Base64
        const toBase64 = file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });
    </script>
</body>
</html>
