<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap');
    body { background-color: #f0f2f5; font-family: 'Sarabun', sans-serif; padding-bottom: 80px; }
    .job-card { border: none; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 15px; background: white; }
    .status-badge { font-size: 0.8rem; padding: 4px 10px; border-radius: 20px; }
    .bg-pending { background-color: #fff3cd; color: #856404; }
    .bg-progress { background-color: #cce5ff; color: #004085; }
    .nav-pills .nav-link.active { background-color: #00B900; color: white !important; }
    .nav-pills .nav-link { color: #555; background: #e9ecef; margin: 0 5px; border-radius: 20px; }
    
    /* ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ (Timeline) */
    .history-box { background: #f8f9fa; border-radius: 8px; padding: 10px; font-size: 0.85rem; max-height: 150px; overflow-y: auto; border: 1px solid #dee2e6; }
    .history-item { margin-bottom: 8px; border-bottom: 1px dashed #ddd; padding-bottom: 5px; }
    .history-item:last-child { border-bottom: none; margin-bottom: 0; }
    
    .preview-img { width: 100%; max-height: 200px; object-fit: cover; border-radius: 8px; display: none; margin-top: 10px; border: 1px solid #ddd; }
  </style>
</head>
<body>

  <div class="container mt-3">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5 class="fw-bold m-0">üõ†Ô∏è ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°</h5>
      <span id="userRoleBadge" class="badge bg-secondary">Checking...</span>
    </div>
    
    <ul class="nav nav-pills nav-fill mb-3" id="pills-tab">
      <li class="nav-item"><button class="nav-link active fw-bold" id="tab-pending" data-bs-toggle="pill" data-bs-target="#content-pending">üì¢ ‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô</button></li>
      <li class="nav-item"><button class="nav-link fw-bold" id="tab-my" data-bs-toggle="pill" data-bs-target="#content-my">üë∑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥</button></li>
    </ul>
  </div>

  <div class="container tab-content">
    <div class="tab-pane fade show active" id="content-pending"><div id="list-pending" class="text-center mt-5"><div class="spinner-border text-success"></div></div></div>
    <div class="tab-pane fade" id="content-my"><div id="list-my" class="text-center mt-5"><small class="text-muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á</small></div></div>
  </div>

  <div class="modal fade" id="actionModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title fw-bold">üìù ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="modalCaseId">
          <div class="mb-3">
            <label class="form-label fw-bold">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</label>
            <select class="form-select" id="actionType" onchange="toggleActionUI()">
              <option value="update">üü° ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤ (‡∏á‡∏≤‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡∏ö)</option>
              </select>
          </div>
          <div class="mb-3">
            <label class="form-label">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î / ‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÑ‡∏õ</label>
            <textarea class="form-control" id="actionDetail" rows="3" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÑ‡∏õ..."></textarea>
          </div>
          <div class="mb-3">
            <label class="form-label">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
            <input type="file" class="form-control" id="actionImage" accept="image/*" onchange="previewFile()">
            <img id="imgPreview" class="preview-img">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          <button type="button" class="btn btn-primary" id="btnActionSubmit" onclick="submitAction()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        </div>
      </div>
    </div>
  </div>

  <input type="hidden" id="userId"><input type="hidden" id="displayName">

  <script>
    // üö®üö® URL ‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á Apps Script üö®üö®
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbyWNYN_WZVBOnmsegtajxRke5uiHbC1lCHU1D2nQSbiDYJp-seE56dHo8VEgpGXS-96ug/exec';
    
    // üö®üö® LIFF ID ‡∏ä‡πà‡∏≤‡∏á üö®üö®
    const LIFF_ID = '2008927233-soAbiW4q';

    let userIsAdmin = false;

    async function main() {
      await liff.init({ liffId: LIFF_ID });
      if (!liff.isLoggedIn()) { liff.login(); return; }
      const profile = await liff.getProfile();
      document.getElementById('userId').value = profile.userId;
      document.getElementById('displayName').value = profile.displayName;
      fetchJobs();
    }
    main();

    function fetchJobs() {
      const userId = document.getElementById('userId').value;
      fetch(GAS_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
        body: JSON.stringify({ action: 'get_staff_jobs', userId: userId })
      })
      .then(res => res.json())
      .then(data => {
        userIsAdmin = data.isAdmin;
        updateUserBadge(userIsAdmin);
        renderJobs('list-pending', data.jobs.pending, true);
        renderJobs('list-my', data.jobs.my, false);
      });
    }

    function updateUserBadge(isAdmin) {
      const badge = document.getElementById('userRoleBadge');
      if (isAdmin) {
        badge.className = 'badge bg-danger';
        badge.innerText = 'Admin / JorPor';
      } else {
        badge.className = 'badge bg-success';
        badge.innerText = 'Technician';
      }
    }

    function renderJobs(elId, jobs, isPending) {
      const container = document.getElementById(elId);
      if (!jobs || jobs.length === 0) {
        container.innerHTML = '<p class="mt-5 text-muted">üéâ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>'; return;
      }
      let html = '';
      jobs.forEach(job => {
        let historyHtml = formatHistory(job.history);
        html += `
          <div class="job-card p-3">
            <div class="d-flex justify-content-between">
              <h6 class="fw-bold text-dark">${job.type}</h6>
              <span class="status-badge ${isPending ? 'bg-pending' : 'bg-progress'}">${job.status}</span>
            </div>
            <small class="text-muted">#${job.caseId} | ${job.date}</small>
            <div class="alert alert-light border p-2 mt-2 mb-2"><strong>‡∏≠‡∏≤‡∏Å‡∏≤‡∏£:</strong> ${job.detail}</div>
            
            <div class="mb-2">
              <small class="fw-bold text-muted">üïí Timeline:</small>
              <div class="history-box mt-1">${historyHtml}</div>
            </div>

            <p class="small mb-2">üìç ${job.location}<br>üë§ ${job.reporter} (${job.tel})</p>
            <div class="d-flex gap-2">
              ${job.folderUrl ? `<a href="${job.folderUrl}" target="_blank" class="btn btn-sm btn-outline-secondary flex-grow-1">üì∑ ‡∏£‡∏π‡∏õ</a>` : ''}
              ${isPending ? 
                `<button onclick="acceptJob('${job.caseId}')" class="btn btn-sm btn-primary flex-grow-1">üõ†Ô∏è ‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô</button>` : 
                `<button onclick="openActionModal('${job.caseId}')" class="btn btn-sm btn-warning flex-grow-1 text-dark">üìù ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô</button>`
              }
            </div>
          </div>`;
      });
      container.innerHTML = html;
    }

    function formatHistory(str) {
      if (!str || str === '-') return '<div class="text-muted text-center">- ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô -</div>';
      return str.split('\n').map(line => `<div class="history-item">üîπ ${line}</div>`).join('');
    }

    function acceptJob(caseId) {
      Swal.fire({ title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô?', showCancelButton: true, confirmButtonText: '‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô' }).then((r) => {
        if (r.isConfirmed) {
          sendRequest({ action: 'accept_job', caseId: caseId, userId: document.getElementById('userId').value, name: document.getElementById('displayName').value });
        }
      });
    }

    function openActionModal(caseId) {
      document.getElementById('modalCaseId').value = caseId;
      document.getElementById('actionDetail').value = '';
      document.getElementById('actionImage').value = '';
      document.getElementById('imgPreview').style.display = 'none';

      const select = document.getElementById('actionType');
      select.innerHTML = '<option value="update">üü° ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤ (‡∏á‡∏≤‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡∏ö)</option>';
      if (userIsAdmin) {
        select.innerHTML += '<option value="completed">üü¢ QC ‡∏ú‡πà‡∏≤‡∏ô / ‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô (‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå)</option>';
      }
      toggleActionUI();
      new bootstrap.Modal(document.getElementById('actionModal')).show();
    }

    function toggleActionUI() {
      const type = document.getElementById('actionType').value;
      const btn = document.getElementById('btnActionSubmit');
      if (type === 'completed') {
        btn.className = 'btn btn-success'; btn.innerText = '‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô';
      } else {
        btn.className = 'btn btn-primary'; btn.innerText = 'üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤';
      }
    }

    function previewFile() {
      const file = document.getElementById('actionImage').files[0];
      const preview = document.getElementById('imgPreview');
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) { preview.src = e.target.result; preview.style.display = 'block'; }
        reader.readAsDataURL(file);
      }
    }

    function submitAction() {
      const caseId = document.getElementById('modalCaseId').value;
      const remark = document.getElementById('actionDetail').value;
      const status = document.getElementById('actionType').value;
      const fileInput = document.getElementById('actionImage');
      
      if (!remark) { Swal.fire('‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î', 'warning'); return; }
      Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

      const payload = { action: 'close_job', caseId: caseId, remark: remark, status: status, image: null };
      if (fileInput.files.length > 0) {
        const reader = new FileReader();
        reader.readAsDataURL(fileInput.files[0]);
        reader.onload = function () { payload.image = reader.result; sendRequest(payload); };
      } else {
        sendRequest(payload);
      }
    }

    function sendRequest(payload) {
      fetch(GAS_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
        body: JSON.stringify(payload)
      })
      .then(res => res.json())
      .then(data => {
        bootstrap.Modal.getInstance(document.getElementById('actionModal')).hide();
        if (data.success) { Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß', 'success').then(() => fetchJobs()); }
        else { Swal.fire('Error', data.message, 'error'); }
      });
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
