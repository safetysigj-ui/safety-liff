<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ä‡πà‡∏≤‡∏á‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap');
    body { background-color: #f0f2f5; font-family: 'Sarabun', sans-serif; padding-bottom: 80px; }
    .job-card { border: none; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 15px; background: white; }
    .status-badge { font-size: 0.8rem; padding: 4px 10px; border-radius: 20px; }
    .bg-pending { background-color: #fff3cd; color: #856404; }
    .bg-progress { background-color: #cce5ff; color: #004085; }
    .nav-pills .nav-link.active { background-color: #00B900; } /* ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß LINE */
    .nav-pills .nav-link { color: #555; }
  </style>
</head>
<body>

  <div class="container mt-3">
    <ul class="nav nav-pills nav-fill mb-3" id="pills-tab" role="tablist">
      <li class="nav-item">
        <button class="nav-link active fw-bold" id="tab-pending" data-bs-toggle="pill" data-bs-target="#content-pending" type="button">üì¢ ‡∏á‡∏≤‡∏ô‡∏£‡∏≠‡∏£‡∏±‡∏ö</button>
      </li>
      <li class="nav-item">
        <button class="nav-link fw-bold" id="tab-my" data-bs-toggle="pill" data-bs-target="#content-my" type="button">üë∑ ‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</button>
      </li>
    </ul>
  </div>

  <div class="container tab-content" id="pills-tabContent">
    
    <div class="tab-pane fade show active" id="content-pending">
      <div id="list-pending" class="text-center text-muted mt-5">
        <div class="spinner-border text-success" role="status"></div>
        <p class="mt-2">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏á‡∏≤‡∏ô...</p>
      </div>
    </div>

    <div class="tab-pane fade" id="content-my">
      <div id="list-my" class="text-center text-muted mt-5">
        <small>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÑ‡∏ß‡πâ</small>
      </div>
    </div>
  </div>

  <input type="hidden" id="userId">
  <input type="hidden" id="displayName">

  <script>
    // üö®üö® ‡πÉ‡∏™‡πà URL ‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö üö®üö®
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbyWNYN_WZVBOnmsegtajxRke5uiHbC1lCHU1D2nQSbiDYJp-seE56dHo8VEgpGXS-96ug/exec';
    
    // üö®üö® ‡πÉ‡∏™‡πà LIFF ID ‡∏≠‡∏±‡∏ô‡∏ó‡∏µ‡πà 2 (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ä‡πà‡∏≤‡∏á) üö®üö®
    const LIFF_ID = '2008927233-soAbiW4q'; // <-- ‡πÅ‡∏Å‡πâ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô ID ‡∏≠‡∏±‡∏ô‡∏ó‡∏µ‡πà 2 ‡∏Ç‡∏≠‡∏á‡∏û‡∏µ‡πà‡∏ô‡∏∞

    async function main() {
      try {
        await liff.init({ liffId: LIFF_ID });
        if (!liff.isLoggedIn()) { liff.login(); return; }
        
        const profile = await liff.getProfile();
        document.getElementById('userId').value = profile.userId;
        document.getElementById('displayName').value = profile.displayName;
        
        // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô
        fetchJobs();

      } catch (err) { Swal.fire('Error', 'LIFF Error: ' + err, 'error'); }
    }
    main();

    function fetchJobs() {
      const userId = document.getElementById('userId').value;
      
      fetch(GAS_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
        body: JSON.stringify({ action: 'get_staff_jobs', userId: userId })
      })
      .then(res => res.json())
      .then(data => {
        renderJobs('list-pending', data.jobs.pending, true); // True = ‡∏°‡∏µ‡∏õ‡∏∏‡πà‡∏°‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô
        renderJobs('list-my', data.jobs.my, false);          // False = ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏∏‡πà‡∏°‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô (‡∏°‡∏µ‡∏õ‡∏∏‡πà‡∏°‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡πÅ‡∏ó‡∏ô ‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏ó‡∏≥‡∏ï‡πà‡∏≠)
      });
    }

    function renderJobs(elementId, jobs, isPendingTab) {
      const container = document.getElementById(elementId);
      if (jobs.length === 0) {
        container.innerHTML = '<p class="mt-5 text-muted">üéâ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á</p>';
        return;
      }
      
      let html = '';
      jobs.forEach(job => {
        html += `
          <div class="job-card p-3">
            <div class="d-flex justify-content-between align-items-start">
              <h6 class="fw-bold text-dark mb-1">${job.type}</h6>
              <span class="status-badge ${isPendingTab ? 'bg-pending' : 'bg-progress'}">${job.status}</span>
            </div>
            <small class="text-muted d-block mb-2">#${job.caseId} | üìÖ ${job.date}</small>
            
            <div class="alert alert-light border p-2 mb-2" style="font-size:0.9rem;">
              ${job.detail}
            </div>
            
            <p class="mb-1" style="font-size:0.85rem;">
              üìç <strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà:</strong> ${job.location}<br>
              üë§ <strong>‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á:</strong> ${job.reporter} (Tel: ${job.tel})
            </p>
            
            <div class="d-flex gap-2 mt-3">
              ${job.folderUrl ? `<a href="${job.folderUrl}" target="_blank" class="btn btn-sm btn-outline-secondary flex-grow-1">üì∑ ‡∏î‡∏π‡∏£‡∏π‡∏õ</a>` : ''}
              
              ${isPendingTab ? 
                `<button onclick="acceptJob('${job.caseId}')" class="btn btn-sm btn-primary flex-grow-1">üõ†Ô∏è ‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô</button>` 
                : 
                `<button class="btn btn-sm btn-success flex-grow-1">‚úÖ ‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô (Coming Soon)</button>`
              }
            </div>
          </div>
        `;
      });
      container.innerHTML = html;
    }

    function acceptJob(caseId) {
      Swal.fire({
        title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô?',
        text: "‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°",
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡πÄ‡∏•‡∏¢',
        cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
      }).then((result) => {
        if (result.isConfirmed) {
          // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô
          const userId = document.getElementById('userId').value;
          const name = document.getElementById('displayName').value;
          
          Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
          
          fetch(GAS_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'text/plain;charset=utf-8' },
            body: JSON.stringify({ action: 'accept_job', caseId: caseId, userId: userId, name: name })
          })
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!', 'success').then(() => fetchJobs()); // ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà
            } else {
              Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', data.message, 'error');
            }
          });
        }
      });
    }
  </script>
  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
